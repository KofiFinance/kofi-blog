"use strict";(self.webpackChunkkofi_docs=self.webpackChunkkofi_docs||[]).push([[22],{9459:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var i=n(134),t=n(4848),a=n(8453);const r={slug:"transaction-shuffling-and-mev-on-aptos",title:"Transaction Shuffling and MEV on Aptos",authors:["kofi"],tags:["mev","aptos"],date:new Date("2025-02-20T00:00:00.000Z")},o=void 0,l={authorsImageUrls:[void 0]},c=[{value:"Transaction lifecycle on Aptos",id:"transaction-lifecycle-on-aptos",level:2},{value:"How transaction shuffling works on Aptos",id:"how-transaction-shuffling-works-on-aptos",level:2},{value:"Example 1",id:"example-1",level:3},{value:"Example 2",id:"example-2",level:3},{value:"Live Parameters",id:"live-parameters",level:2},{value:"Implications for MEV Strategies",id:"implications-for-mev-strategies",level:2}];function d(e){const s={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h2,{id:"transaction-lifecycle-on-aptos",children:"Transaction lifecycle on Aptos"}),"\n",(0,t.jsx)(s.p,{children:"On Aptos, transactions follow a structured lifecycle to achieve finality. Initially, transactions are submitted to full nodes, which propagate them to validator nodes. Within the consensus layer\u2014powered by AptosBFT\u2014transactions are collected into a proposed block and reordered using a pre-execution shuffling mechanism to balance the load and enhance fairness. Once consensus is reached among validators, the agreed-upon block, containing the shuffled transaction order and cryptographic proofs, is finalized. The execution engine then processes these transactions, leveraging Block-STM for parallel execution, and updates the ledger, achieving rapid finality with robust security. This design integrates shuffling within consensus to determine the transaction order, followed by efficient execution and ledger confirmation."}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Pre-Execution Shuffling"})}),"\n",(0,t.jsx)(s.p,{children:"In between consensus and execution, Aptos uses a pre-execution shuffling mechanism to order transactions. This mechanism is used to:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Balance the Load:"})," Prevent a burst of transactions from the same sender or of the same type."]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["As noted in ",(0,t.jsx)(s.a,{href:"https://github.com/aptos-foundation/AIPs/blob/main/aips/aip-68.md",children:"AIP-68"}),":"]}),"\n",(0,t.jsxs)(s.blockquote,{children:["\n",(0,t.jsx)(s.p,{children:'"...This (Long block latency) is expected to happen in this particular situation where spikes of conflicting/sequential transactions from a popular module (smart contract) dominates the traffic"'}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"how-transaction-shuffling-works-on-aptos",children:"How transaction shuffling works on Aptos"}),"\n",(0,t.jsx)(s.h3,{id:"example-1",children:"Example 1"}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"Transaction Shuffling on Aptos",src:n(480).A+""})}),"\n",(0,t.jsx)(s.p,{children:"The diagram above illustrates how transaction shuffling works in practice. Let's break it down:"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Original Transaction Order:"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"The top row shows transactions in their original order (0-9)"}),"\n",(0,t.jsx)(s.li,{children:"Transactions of the same sender have the same letter"}),"\n",(0,t.jsx)(s.li,{children:"Transactions of the same use case (smart contract) have the same color"}),"\n",(0,t.jsx)(s.li,{children:"Each circle represents a transaction, with numbers indicating their original position"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Shuffled Transaction Order:"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"The bottom row shows transactions after shuffling"}),"\n",(0,t.jsx)(s.li,{children:"The numbers below show their new positions"}),"\n",(0,t.jsxs)(s.li,{children:["With ",(0,t.jsx)(s.code,{children:"sender_spread_factor = 1"}),", transactions from the same sender are spread apart"]}),"\n",(0,t.jsx)(s.li,{children:'Notice how green "A" transactions that were originally clustered are now distributed'}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Shuffling Parameters:"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"sender_spread_factor = 1"}),": Spreads transactions from the same sender"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"platform_use_case_spread_factor = 0"}),": No additional delay for platform transactions"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"user_use_case_spread_factor = 0"}),": No additional delay for user transactions"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Result:"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Transactions from sender A (green) are spread out evenly"}),"\n",(0,t.jsx)(s.li,{children:"Transactions from sender B (blue) and C (orange) maintain relative ordering"}),"\n",(0,t.jsx)(s.li,{children:"Each transaction is shifted by 1 slot relative to others from the same sender"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"example-2",children:"Example 2"}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"Transaction Shuffling on Aptos",src:n(7721).A+""})}),"\n",(0,t.jsx)(s.p,{children:"Let's analyze this diagram which shows a more complex shuffling scenario:"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Original Transaction Order:"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Similar to Example 1, transactions are shown with sender (letter) and use case (color)"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Shuffling Parameters:"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"sender_spread_factor = 2"}),": Spreads transactions from the same sender further apart"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"platform_use_case_spread_factor = 0"}),": No additional delay for platform transactions"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"user_use_case_spread_factor = 1"}),": Slight delay for user transactions"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Key Effects:"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:'"Same context transactions are spaced by 1" - Transactions with the same use case maintain a minimum spacing'}),"\n",(0,t.jsxs)(s.li,{children:['"Same sender transactions are spread by at least 2 slots" - Due to ',(0,t.jsx)(s.code,{children:"sender_spread_factor"})]}),"\n",(0,t.jsxs)(s.li,{children:['"',(0,t.jsx)(s.code,{children:"use_case_spread"})," takes precedence over ",(0,t.jsx)(s.code,{children:"sender_spread"}),'" - The use case spacing is applied first']}),"\n",(0,t.jsx)(s.li,{children:'Some sender spreads "could not be fulfilled" due to competing constraints'}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"This example demonstrates how multiple spread factors interact and sometimes compete, leading to a complex but deterministic reordering that balances various constraints."}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsxs)(s.em,{children:["More examples can be found in test cases in the ",(0,t.jsx)(s.a,{href:"https://github.com/aptos-labs/aptos-core/blob/51e3afbaf4645c7a8dd03b94e47555c0dbed0366/consensus/src/transaction_shuffler/use_case_aware/tests/manual.rs",children:"Aptos codebase"})]})}),"\n",(0,t.jsx)(s.h2,{id:"live-parameters",children:"Live Parameters"}),"\n",(0,t.jsx)(s.p,{children:"The current live parameters for the transaction shuffler are:"}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Parameter"}),(0,t.jsx)(s.th,{children:"Value"}),(0,t.jsx)(s.th,{children:"Effect"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"sender_spread_factor"}),(0,t.jsx)(s.td,{children:"32"}),(0,t.jsx)(s.td,{children:"Spreads transactions from the same sender, with potential saturation"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"platform_use_case_spread_factor"}),(0,t.jsx)(s.td,{children:"0"}),(0,t.jsx)(s.td,{children:"No delay for platform transactions, prioritizing system operations"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"user_use_case_spread_factor"}),(0,t.jsx)(s.td,{children:"4"}),(0,t.jsx)(s.td,{children:"Spaces out user transactions to prevent dominance in order"})]})]})]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.a,{href:"https://github.com/aptos-labs/aptos-core/blob/51e3afbaf4645c7a8dd03b94e47555c0dbed0366/types/src/on_chain_config/execution_config.rs#L159-L160",children:"Code"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-rust",children:"pub fn default_for_genesis() -> Self {\n    TransactionShufflerType::UseCaseAware {\n        sender_spread_factor: 32,\n        platform_use_case_spread_factor: 0,\n        user_use_case_spread_factor: 4,\n    }\n}\n"})}),"\n",(0,t.jsx)(s.h2,{id:"implications-for-mev-strategies",children:"Implications for MEV Strategies"}),"\n",(0,t.jsx)(s.p,{children:"Aptos\u2019s transaction shuffling mechanism fundamentally alters the landscape for Maximum Extractable Value (MEV) strategies by introducing dynamic, consensus-driven reordering before execution, building on an initial gas-based queue. This design imposes significant challenges for MEV extractors:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Reduced Predictability in Ordering:"})," Transactions enter the consensus phase with an initial order based on gas prices, reflecting submitter priority. However, the ",(0,t.jsx)(s.code,{children:"UseCaseAware"})," shuffler, with parameters like sender_spread_factor (32) and ",(0,t.jsx)(s.code,{children:"user_use_case_spread_factor"})," (4), then disperses these transactions across the block based on sender and use-case constraints. This interplay transforms the predictable gas-based sequence into a complex, volume-dependent order, making it harder for MEV actors to anticipate final positions."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Disrupted Concentration and Fairness:"})," While gas offers a starting advantage, shuffling prevents bursts of related transactions (e.g., multiple trades from one sender), diluting opportunities for MEV tactics like front-running or arbitrage. This fosters a more equitable market by reducing the dominance of high-gas bidders who might otherwise cluster transactions for profit."]}),"\n",(0,t.jsx)(s.p,{children:"The shuffling process\u2014integrated into the AptosBFT consensus layer\u2014begins with a gas-prioritized queue, then applies use-case prioritization (e.g., spacing user transactions by 4 slots) and sender-specific spreads (e.g., up to 32 slots). This layered approach, backed by a priority queue system, evolves transaction ordering beyond simple gas auctions. For instance, a bot attempting to front-run a large decentralized exchange trade with a high gas bid might still lose its edge if shuffling spreads its transaction apart from the target. While this enhances fairness and load balancing, it may slightly delay time-sensitive trades initially favored by gas, a trade-off for resilience."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"MEV strategies must now adapt, potentially shifting from exploiting gas-driven order to analyzing shuffle patterns across blocks. As MEV techniques advance, Aptos\u2019s tunable shuffling parameters, layered atop gas prioritization, will be key to sustaining an equitable ecosystem, indirectly bolstering network integrity by curbing manipulative reorderings."})]})}function h(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},480:(e,s,n)=>{n.d(s,{A:()=>i});const i=n.p+"assets/images/shuffling-1.drawio-1dd271386ef7d0953bd8e6fe733b11c1.svg"},7721:(e,s,n)=>{n.d(s,{A:()=>i});const i=n.p+"assets/images/shuffling-2.drawio-7d24466d709aa486686957e04f272456.svg"},134:e=>{e.exports=JSON.parse('{"permalink":"/transaction-shuffling-and-mev-on-aptos","editUrl":"https://github.com/KofiFinance/kofi-blog/tree/main/blog/2025-02-15-MEV-part-2/2025-02-15-MEV-part-2.mdx","source":"@site/blog/2025-02-15-MEV-part-2/2025-02-15-MEV-part-2.mdx","title":"Transaction Shuffling and MEV on Aptos","description":"Transaction lifecycle on Aptos","date":"2025-02-20T00:00:00.000Z","tags":[{"inline":true,"label":"mev","permalink":"/tags/mev"},{"inline":true,"label":"aptos","permalink":"/tags/aptos"}],"readingTime":4.7,"hasTruncateMarker":false,"authors":[{"name":"Kofi Finance","title":"Kofi Finance","url":"https://kofi.finance","page":{"permalink":"/authors/kofi"},"socials":{"x":"https://x.com/kofi_finance","github":"https://github.com/kofi_finance"},"imageURL":"https://github.com/wagmitt/branding/blob/main/logo.png?raw=true","key":"kofi"}],"frontMatter":{"slug":"transaction-shuffling-and-mev-on-aptos","title":"Transaction Shuffling and MEV on Aptos","authors":["kofi"],"tags":["mev","aptos"],"date":"2025-02-20T00:00:00.000Z"},"unlisted":false,"nextItem":{"title":"An Introduction to MEV and Its Impact on Aptos","permalink":"/introduction-to-mev-and-aptos"}}')}}]);